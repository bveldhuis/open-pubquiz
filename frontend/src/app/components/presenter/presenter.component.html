<div class="container">
  <div class="presenter-content">
    <h1 class="presenter-title">Quiz Presenter</h1>
    
    <!-- Create Session Form -->
    <div *ngIf="!currentSession" class="create-session-card">
      <h2>Create New Quiz Session</h2>
      <form [formGroup]="createForm" (ngSubmit)="createSession()" class="create-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Session Name</mat-label>
          <input matInput formControlName="sessionName" placeholder="Enter session name">
          <mat-error *ngIf="createForm.get('sessionName')?.hasError('required')">
            Session name is required
          </mat-error>
        </mat-form-field>

        <button 
          mat-raised-button 
          color="primary" 
          type="submit" 
          class="create-button"
          [disabled]="createForm.invalid || isCreating">
          <mat-spinner *ngIf="isCreating" diameter="20" class="spinner"></mat-spinner>
          <span *ngIf="!isCreating">Create Session</span>
        </button>
      </form>
    </div>

    <!-- Session Management -->
    <div *ngIf="currentSession" class="session-management">
      <!-- Session Configuration UI -->
      <div *ngIf="showConfigurationForm" class="session-config-section">
        <app-session-config 
          [sessionCode]="currentSession.code"
          (configurationComplete)="onSessionConfigured($event)"
          (configurationCancelled)="onConfigurationCancelled()">
        </app-session-config>
      </div>

      <!-- Session Info Card -->
      <div *ngIf="!showConfigurationForm" class="session-info-card">
        <h2>Session: {{ currentSession.name }}</h2>
        
        <div class="connection-status">
          <mat-icon [class]="isConnected ? 'connected' : 'disconnected'">
            {{ isConnected ? 'wifi' : 'wifi_off' }}
          </mat-icon>
          <span>{{ isConnected ? 'Connected' : 'Disconnected' }}</span>
        </div>
        
        <div class="session-code">
          <span class="code-label">Session Code:</span>
          <span class="code-value">{{ currentSession.code }}</span>
        </div>
        
        <div class="qr-section">
          <app-qr-code 
            [sessionCode]="currentSession.code"
            [sessionName]="currentSession.name"
            (qrGenerated)="onQrGenerated($event)"
            (error)="onQrError($event)">
          </app-qr-code>
        </div>

        <div class="session-stats">
          <div class="stat-item">
            <span class="stat-label">Status:</span>
            <span class="stat-value" [class]="currentSession.status">
              {{ currentSession.status | titlecase }}
            </span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Current Round:</span>
            <span class="stat-value">{{ currentSession.current_round }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Teams Joined:</span>
            <span class="stat-value">{{ teams.length }}</span>
          </div>
        </div>

        <div class="teams-section" *ngIf="teams.length > 0">
          <h3>Teams in Session</h3>
          <div class="teams-list">
            <div class="team-item" *ngFor="let team of teams">
              <mat-icon>group</mat-icon>
              <span>{{ team.name }}</span>
            </div>
          </div>
        </div>

        <!-- Session Configuration Summary -->
        <div class="config-summary" *ngIf="sessionConfiguration">
          <h3>Session Configuration</h3>
          <div class="summary-content">
            <div class="summary-item">
              <strong>Total Rounds:</strong> {{ sessionConfiguration.total_rounds }}
            </div>
            <div class="summary-item" *ngFor="let round of sessionConfiguration.round_configurations">
              <strong>Round {{ round.roundNumber }}:</strong> {{ round.themeName }}
              <div class="round-details">
                <span *ngFor="let qt of round.questionTypes" class="question-type-summary">
                  <span *ngIf="qt.enabled">{{ qt.questionCount }} {{ getQuestionTypeDisplayName(qt.type) }}</span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="action-buttons" *ngIf="!showConfigurationForm">
         <button mat-raised-button color="primary" (click)="showSessionConfiguration()" *ngIf="!sessionConfiguration">
           <mat-icon>settings</mat-icon>
           Configure Session
         </button>
         
         <button mat-raised-button color="accent" (click)="generateQuestionsForCurrentRound()" *ngIf="sessionConfiguration && questions.length === 0">
           <mat-icon>quiz</mat-icon>
           Generate Questions
         </button>
         
         <button mat-raised-button color="warn" (click)="endSession()">
           <mat-icon>stop</mat-icon>
           End Session
         </button>
       </div>

                   <!-- Quiz Management Section -->
        <div class="quiz-management" *ngIf="questions.length > 0">
                         <div class="quiz-header" *ngIf="!showReview && !showLeaderboard">
            <h3>Round {{ currentSession.current_round }} - Question {{ currentQuestionIndex + 1 }} of {{ questions.length }}</h3>
            <div class="quiz-status">
              <span class="status-badge" [class]="getQuizStatusClass()">
                {{ getQuizStatusText() }}
              </span>
            </div>
          </div>

                         <!-- Current Question Display -->
                           <div class="current-question" *ngIf="currentQuestion && !showReview && !showLeaderboard">
                               <app-question-display
                [question]="currentQuestion"
                [isActive]="isQuestionActive"
                [showCorrectAnswer]="showReview"
                [submissionsReceived]="submissionsReceived"
                [totalTeams]="teams.length"
                [canStart]="false"
                [hasAnswers]="currentAnswers.length > 0"
                [timeRemaining]="timeRemaining"
                [totalTime]="currentQuestion.time_limit || 60"
                [showControls]="true"
                [isLastQuestion]="currentQuestionIndex === questions.length - 1"
                (startQuestion)="startQuestion()"
                (endQuestion)="endQuestion()"
                (showReview)="showQuestionReview()"
                (endRound)="endRound()"
                (onTimeUp)="onTimeUp()"
                (onTimeChanged)="onTimeChanged($event)">
              </app-question-display>
           </div>

          <!-- Question Navigation -->
          <div class="question-navigation" *ngIf="!isQuestionActive && !showReview && !showLeaderboard">
            <div class="nav-buttons">
              <button 
                mat-stroked-button 
                (click)="previousQuestion()" 
                [disabled]="currentQuestionIndex === 0">
                <mat-icon>arrow_back</mat-icon>
                Previous Question
              </button>
              
              <button 
                mat-raised-button 
                color="primary" 
                (click)="startQuestion()"
                [disabled]="!currentQuestion">
                <mat-icon>play_arrow</mat-icon>
                Start Question
              </button>
              
              <button 
                mat-stroked-button 
                (click)="nextQuestion()" 
                [disabled]="currentQuestionIndex === questions.length - 1"
                *ngIf="currentQuestionIndex < questions.length - 1">
                Next Question
                <mat-icon>arrow_forward</mat-icon>
              </button>
              
              <button 
                mat-raised-button 
                color="accent" 
                (click)="endRound()"
                *ngIf="currentQuestionIndex === questions.length - 1">
                <mat-icon>flag</mat-icon>
                End Round & Review
              </button>
            </div>
          </div>

          <!-- Review Section -->
          <div class="review-section" *ngIf="showReview && currentQuestion">
            <app-answer-review
              [question]="currentQuestion"
              [answers]="currentAnswers"
              [isLastQuestion]="currentQuestionIndex === questions.length - 1"
              [isLoading]="isLoadingAnswers"
              (scoreAnswer)="scoreAnswer($event.answerId, $event.points, $event.isCorrect)"
              (nextQuestion)="nextReviewQuestion()"
              (showLeaderboard)="showLeaderboardView()">
            </app-answer-review>
          </div>

          <!-- Leaderboard Section -->
          <div class="leaderboard-section" *ngIf="showLeaderboard">
            <app-leaderboard
              [teams]="leaderboardTeams"
              [currentRound]="currentSession.current_round || 1">
            </app-leaderboard>
            
            <div class="leaderboard-actions" *ngIf="currentSession">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="startNextRound()"
                *ngIf="!isLastRound()">
                <mat-icon>play_arrow</mat-icon>
                Start Next Round
              </button>
              <button 
                mat-raised-button 
                color="accent" 
                (click)="endSession()"
                *ngIf="isLastRound()">
                <mat-icon>flag</mat-icon>
                End Session
              </button>
            </div>
          </div>
        </div>
    </div>

    <!-- Final Leaderboard (shown after session ends) -->
    <div class="final-leaderboard-section" *ngIf="showLeaderboard && !currentSession">
      <div class="final-leaderboard-card">
        <h2>üèÜ Final Results</h2>
        <app-leaderboard
          [teams]="leaderboardTeams"
          [currentRound]="1">
        </app-leaderboard>
        
        <div class="final-leaderboard-actions">
          <button 
            mat-raised-button 
            color="primary" 
            (click)="createNewSession()">
            <mat-icon>add</mat-icon>
            Create New Session
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
