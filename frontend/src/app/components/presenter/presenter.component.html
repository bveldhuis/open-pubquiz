<div class="container">
  <div class="presenter-content">
    <h1 class="presenter-title">Quiz Presenter</h1>

    <!-- Create Session Form -->
    @if (!currentSession) {
      <div class="create-session-card">
        <h2>Create New Quiz Session</h2>
        <form [formGroup]="sessionForm" (ngSubmit)="createSession()" class="create-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Session Name</mat-label>
            <input matInput formControlName="sessionName" placeholder="Enter session name">
            @if (sessionForm.get('sessionName')?.hasError('required')) {
              <mat-error>
                Session name is required
              </mat-error>
            }
          </mat-form-field>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            class="create-button"
            [disabled]="sessionForm.invalid || isLoading">
            @if (isLoading) {
              <mat-spinner diameter="20" class="spinner"></mat-spinner>
            }
            @if (!isLoading) {
              <span>Create Session</span>
            }
          </button>
        </form>
      </div>
    }

    <!-- Session Management -->
    @if (currentSession) {
      <div class="session-management">
        <!-- Session Configuration UI -->
        @if (showConfigurationForm) {
          <div class="session-config-section">
            <app-session-config
              [sessionCode]="currentSession.code"
              (configurationComplete)="onSessionConfigured($event)"
              (configurationCancelled)="onConfigurationCancelled()">
            </app-session-config>
          </div>
        }
        <!-- Session Info Card -->
        @if (!showConfigurationForm) {
          <div class="session-info-card">
            <h2>Session: {{ currentSession.name }}</h2>
            <div class="connection-status">
              <mat-icon [class]="isConnected ? 'connected' : 'disconnected'">
                {{ isConnected ? 'wifi' : 'wifi_off' }}
              </mat-icon>
              <span>{{ isConnected ? 'Connected' : 'Disconnected' }}</span>
            </div>
            <div class="session-code">
              <span class="code-label">Session Code:</span>
              <span class="code-value">{{ currentSession.code }}</span>
            </div>
            <div class="qr-section">
              <app-qr-code
                [sessionCode]="currentSession.code"
                [sessionName]="currentSession.name"
                (qrGenerated)="onQrGenerated($event)"
                (error)="onQrError($event)">
              </app-qr-code>
            </div>
            <div class="session-stats">
              <div class="stat-item">
                <span class="stat-label">Status:</span>
                <span class="stat-value" [class]="currentSession.status">
                  {{ currentSession.status | titlecase }}
                </span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Current Round:</span>
                <span class="stat-value">{{ currentSession.current_round }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Teams Joined:</span>
                <span class="stat-value">{{ teams.length }}</span>
              </div>
            </div>
            @if (teams.length > 0) {
              <div class="teams-section">
                <h3>Teams in Session</h3>
                <div class="teams-list">
                  @for (team of teams; track team) {
                    <div class="team-item">
                      <mat-icon>group</mat-icon>
                      <span>{{ team.name }}</span>
                    </div>
                  }
                </div>
              </div>
            }
            <!-- Session Configuration Summary -->
            @if (sessionConfiguration) {
              <div class="config-summary">
                <h3>Session Configuration</h3>
                <div class="summary-content">
                  <div class="summary-item">
                    <strong>Total Rounds:</strong> {{ sessionConfiguration.total_rounds }}
                  </div>
                  @for (round of sessionConfiguration.round_configurations; track round) {
                    <div class="summary-item">
                      <strong>Round {{ round.roundNumber }}:</strong> {{ round.themeName }}
                      <div class="round-details">
                        @for (qt of round.questionTypes; track qt) {
                          <span class="question-type-summary">
                            @if (qt.enabled) {
                              <span>{{ qt.questionCount }} {{ getQuestionTypeDisplayName(qt.type) }}</span>
                            }
                          </span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
        @if (!showConfigurationForm) {
          <div class="action-buttons">
            @if (!sessionConfiguration) {
              <button mat-raised-button color="primary" (click)="showSessionConfiguration()">
                <mat-icon>settings</mat-icon>
                Configure Session
              </button>
            }
            @if (sessionConfiguration && questions.length === 0) {
              <button mat-raised-button color="accent" (click)="generateQuestionsForCurrentRound()">
                <mat-icon>quiz</mat-icon>
                Generate Questions
              </button>
            }
            <button mat-raised-button color="warn" (click)="endSession()">
              <mat-icon>stop</mat-icon>
              End Session
            </button>
          </div>
        }
        <!-- Quiz Management Section -->
        @if (questions.length > 0) {
          <div class="quiz-management">
            @if (!showReview && !showLeaderboard) {
              <div class="quiz-header">
                <h3>Round {{ currentSession.current_round }} - Question {{ currentQuestionIndex + 1 }} of {{ questions.length }}</h3>
                <div class="quiz-status">
                  <span class="status-badge" [class]="getQuizStatusClass()">
                    {{ getQuizStatusText() }}
                  </span>
                </div>
              </div>
            }
            <!-- Current Question Display -->
            @if (currentQuestion && !showReview && !showLeaderboard) {
              <div class="current-question">
                <app-question-display
                  [question]="currentQuestion"
                  [isActive]="isQuestionActive"
                  [showCorrectAnswer]="showReview"
                  [submissionsReceived]="submissionsReceived"
                  [totalTeams]="teams.length"
                  [canStart]="false"
                  [hasAnswers]="currentAnswers.length > 0"
                  [timeRemaining]="timeRemaining"
                  [totalTime]="currentQuestion.time_limit || 60"
                  [showControls]="true"
                  [isLastQuestion]="currentQuestionIndex === questions.length - 1"
                  (startQuestion)="startQuestion()"
                  (endQuestion)="endQuestion()"
                  (showReview)="showQuestionReview()"
                  (endRound)="endRound()"
                  (timeUp)="onTimeUp()"
                  (timeChanged)="onTimeChanged($event)">
                </app-question-display>
              </div>
            }
            <!-- Question Navigation -->
            @if (!isQuestionActive && !showReview && !showLeaderboard) {
              <div class="question-navigation">
                <div class="nav-buttons">
                  <button
                    mat-stroked-button
                    (click)="previousQuestion()"
                    [disabled]="currentQuestionIndex === 0">
                    <mat-icon>arrow_back</mat-icon>
                    Previous Question
                  </button>
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="startQuestion()"
                    [disabled]="!currentQuestion">
                    <mat-icon>play_arrow</mat-icon>
                    Start Question
                  </button>
                  @if (currentQuestionIndex < questions.length - 1) {
                    <button
                      mat-stroked-button
                      (click)="nextQuestion()"
                      [disabled]="currentQuestionIndex === questions.length - 1"
                      >
                      Next Question
                      <mat-icon>arrow_forward</mat-icon>
                    </button>
                  }
                  @if (currentQuestionIndex === questions.length - 1) {
                    <button
                      mat-raised-button
                      color="accent"
                      (click)="endRound()"
                      >
                      <mat-icon>flag</mat-icon>
                      End Round & Review
                    </button>
                  }
                </div>
              </div>
            }
            <!-- Review Section -->
            @if (showReview && currentQuestion) {
              <div class="review-section">
                <app-answer-review
                  [question]="currentQuestion"
                  [answers]="currentAnswers"
                  [isLastQuestion]="currentQuestionIndex === questions.length - 1"
                  [isLoading]="isLoadingAnswers"
                  (scoreAnswer)="scoreAnswer($event.answerId, $event.points, $event.isCorrect)"
                  (nextQuestion)="nextReviewQuestion()"
                  (showLeaderboard)="showLeaderboardView()">
                </app-answer-review>
              </div>
            }
            <!-- Leaderboard Section -->
            @if (showLeaderboard) {
              <div class="leaderboard-section">
                <app-leaderboard
                  [teams]="leaderboardTeams"
                  [currentRound]="currentSession.current_round || 1">
                </app-leaderboard>
                @if (currentSession) {
                  <div class="leaderboard-actions">
                    @if (!isLastRound()) {
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="startNextRound()"
                        >
                        <mat-icon>play_arrow</mat-icon>
                        Start Next Round
                      </button>
                    }
                    @if (isLastRound()) {
                      <button
                        mat-raised-button
                        color="accent"
                        (click)="endSession()"
                        >
                        <mat-icon>flag</mat-icon>
                        End Session
                      </button>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Final Leaderboard (shown after session ends) -->
    @if (showLeaderboard && !currentSession) {
      <div class="final-leaderboard-section">
        <div class="final-leaderboard-card">
          <h2>🏆 Final Results</h2>
          <app-leaderboard
            [teams]="leaderboardTeams"
            [currentRound]="1">
          </app-leaderboard>
          <div class="final-leaderboard-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="createNewSession()">
              <mat-icon>add</mat-icon>
              Create New Session
            </button>
          </div>
        </div>
      </div>
    }
  </div>
</div>
